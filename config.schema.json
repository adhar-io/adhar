{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Adhar Configuration Schema",
  "description": "Schema for config.yaml matching current file structure",
  "type": "object",
  "properties": {
    "globalSettings": {
      "type": "object",
      "description": "Global platform settings",
      "properties": {
        "adharContext": { "type": "string", "minLength": 1 },
        "defaultHost": { "type": "string" },
        "defaultHttpPort": { "type": "integer", "minimum": 1 },
        "defaultHttpsPort": { "type": "integer", "minimum": 1 },
        "enableHAMode": { "type": "boolean" },
        "email": { "type": "string", "format": "email" }
      },
      "additionalProperties": false
    },
    "providers": {
      "type": "object",
      "description": "Provider configurations keyed by provider name (e.g., civo, aws, azure)",
      "additionalProperties": { "$ref": "#/definitions/providerSpec" },
      "properties": {
        "kind": { "$ref": "#/definitions/providerSpec" },
        "aws": { "$ref": "#/definitions/providerSpec" },
        "azure": { "$ref": "#/definitions/providerSpec" },
        "gcp": { "$ref": "#/definitions/providerSpec" },
        "digitalocean": { "$ref": "#/definitions/providerSpec" },
        "civo": { "$ref": "#/definitions/providerSpec" },
        "custom": { "$ref": "#/definitions/providerSpec" }
      }
    },
    "environmentTemplates": {
      "type": "object",
      "description": "Reusable configuration templates for environments",
      "additionalProperties": { "$ref": "#/definitions/environmentTemplate" }
    },
    "environments": {
      "type": "object",
      "description": "Environment definitions keyed by environment name (e.g., dev, test, staging, production)",
      "minProperties": 1,
      "additionalProperties": { "$ref": "#/definitions/environmentConfig" }
    }
  },
  "required": ["providers", "environments"],
  "additionalProperties": false,
  "definitions": {
    "keyValue": {
      "type": "object",
      "description": "Key/value entry",
      "properties": {
        "key": { "type": "string", "minLength": 1 },
        "value": {
          "oneOf": [
            { "type": "string" },
            { "type": "number" },
            { "type": "integer" },
            { "type": "boolean" }
          ]
        }
      },
      "required": ["key", "value"],
      "additionalProperties": false
    },
    "chartSpec": {
      "type": "object",
      "description": "Helm chart specification",
      "properties": {
        "repoURL": { "type": "string", "format": "uri", "pattern": "^https?://" },
        "name": { "type": "string", "minLength": 1 },
        "version": { "type": "string", "minLength": 1 }
      },
      "required": ["repoURL", "name", "version"],
      "additionalProperties": false
    },
    "helmChartConfig": {
      "type": "object",
      "description": "Configuration for deploying a Helm chart",
      "properties": {
        "chart": { "$ref": "#/definitions/chartSpec" },
        "values": {
          "type": "array",
          "description": "Helm values as key/value pairs",
          "items": { "$ref": "#/definitions/keyValue" }
        }
      },
      "required": ["chart"],
      "additionalProperties": false
    },
    "addonConfig": {
      "type": "object",
      "description": "Configuration for a single addon",
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "chart": { "$ref": "#/definitions/chartSpec" },
        "values": {
          "type": "array",
          "items": { "$ref": "#/definitions/keyValue" }
        },
        "targetNamespace": { "type": "string" },
        "createNamespace": { "type": "boolean", "default": false }
      },
      "required": ["name", "chart"],
      "additionalProperties": false
    },
    "coreServicesSpec": {
      "type": "object",
      "description": "Core platform services configuration",
      "properties": {
        "cilium": { "$ref": "#/definitions/helmChartConfig" },
        "nginx": { "$ref": "#/definitions/helmChartConfig" },
        "gitea": { "$ref": "#/definitions/helmChartConfig" },
        "argocd": { "$ref": "#/definitions/helmChartConfig" }
      },
      "additionalProperties": false
    },
    "environmentTemplate": {
      "type": "object",
      "description": "Reusable environment template",
      "properties": {
        "clusterConfig": {
          "type": "array",
          "items": { "$ref": "#/definitions/keyValue" }
        },
        "coreServices": { "$ref": "#/definitions/coreServicesSpec" },
        "addons": {
          "type": "array",
          "items": { "$ref": "#/definitions/addonConfig" }
        }
      },
      "additionalProperties": false
    },
    "environmentConfig": {
      "type": "object",
      "description": "Configuration for a specific environment",
      "properties": {
        "type": { "type": "string", "enum": ["production", "non-production"] },
        "template": { "type": "string" },
        "clusterConfig": {
          "type": "array",
          "items": { "$ref": "#/definitions/keyValue" }
        },
        "coreServices": { "$ref": "#/definitions/coreServicesSpec" },
        "addons": {
          "type": "array",
          "items": { "$ref": "#/definitions/addonConfig" }
        }
      },
      "additionalProperties": false
    },
    "providerSpec": {
      "type": "object",
      "description": "Generic provider configuration",
      "properties": {
        "type": { "type": "string", "minLength": 1 },
        "region": { "type": "string" },
        "primary": { "type": "boolean" },
        "token": { "type": "string" },
        "credentials_file": { "type": "string" },
        "useEnvironment": { "type": "boolean" },
        "config": {
          "type": "object",
          "description": "Provider-specific configuration. Shape varies per provider.",
          "additionalProperties": true,
          "properties": {
            "network_id": { "type": "string" },
            "size": { "type": "string" },
            "disk_image": { "type": "string" },
            "firewall_rules": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "label": { "type": "string" },
                  "rules": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "protocol": { "type": "string" },
                        "start_port": { "type": "string" },
                        "end_port": { "type": "string" },
                        "cidr": {
                          "type": "array",
                          "items": { "type": "string" }
                        },
                        "direction": { "type": "string" }
                      },
                      "additionalProperties": true
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          }
        }
      },
      "required": ["type"],
      "additionalProperties": false
    }
  }
}
